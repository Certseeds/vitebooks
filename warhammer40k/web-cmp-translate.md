# web-cmp-translate 网页使用流程

本文档介绍 `web-cmp-translate` 网页工具的使用流程，该工具旨在辅助翻译英文文本，特别是针对战锤40K等具有大量专有名词的文本内容。

## 1. 界面概览

工具界面主要分为两个区域：

* 主内容区（左侧）：用于上传原文文件和展示原文与译文的对照。
* 侧边栏（右侧）：用于配置API、上传词表、自定义Prompt以及查看操作日志。

## 2. API 配置

在侧边栏的“API 设置”部分，你需要配置以下信息以连接到翻译API：

* API URL：填入你使用的翻译API的接入点URL。
  * 例如，本地部署的Ollama服务，常见的URL可能是 `http://127.0.0.1:11434/v1`。
  * 对于远程服务（如DeepSeek），则填入其提供的API URL，例如 `https://api.deepseek.com`。
* Model Name：填入API所使用的模型名称。
  * 例如，本地Ollama的 `qwen2.5:14b` 或 DeepSeek的 `deepseek-chat`。
* API Token：如果API需要认证，请在此处填入你的API密钥或Token。
  + 本地部署的Ollama服务通常不需要Token。
  + 对于远程服务（如DeepSeek），请根据其文档获取Token并填入。

## 3. 上传原文文件

* 点击主内容区上方的“选择要翻译的文本文件 (txt, md)”按钮。
* 选择一个包含英文原文的纯文本文件（`.txt` 或 `.md` 格式）。
* 文件上传后，其内容会被自动按行分割成段落，并显示在下方的原文区域。空行会被自动排除。

## 4. 词表管理（可选）

工具支持通过上传词表来进行翻译前和翻译后的文本替换，以提高特定术语翻译的准确性和一致性。

### 4.1. 预处理词表

* 作用：在文本发送给翻译API之前，对原文进行替换。通常用于将特定的英文术语硬翻译成目标中文，或修正一些模型容易误解的原文表述。
* 上传：在侧边栏“词表和 Prompt”部分，点击“预处理词表”下的文件选择按钮，上传 `.json` 或 `.txt` 格式的词表文件。
* 格式：
  * `.json`：一个包含 `keywords` 对象的JSON文件，`keywords` 对象内可以有多个分类，每个分类下是键值对，键为英文原文（会自动转为小写），值为替换后的中文。
  * `.txt`：每行一个词条，英文原文和中文译文用一个或多个空格隔开，英文原文在前（会自动转为小写）。
* 逻辑：预处理时，会按照词表中的键（英文）的长度从长到短进行排序，然后不区分大小写地替换原文中匹配到的部分。

推荐加载的预处理词表

+ `web-cmp-translate/resource`目录下的 `mechanicum.json`
+ `web-cmp-translate/resource`目录下的 `names.json`
+ `github.com/Certseeds/wh40k-icons/i18n` 目录下的 `zh-cn.json` 文件

### 4.2. 后处理词表

* 作用：在从翻译API接收到译文之后，对译文进行替换。通常用于修正翻译结果中的特定表达，或统一某些术语的译法。
* 上传：在侧边栏“词表和 Prompt”部分，点击“后处理词表”下的文件选择按钮，上传 `.json` 或 `.txt` 格式的词表文件。
* 格式：与预处理词表类似。
  * `.json`：键为正则表达式字符串，值为替换字符串。
  * `.txt`：键为正则表达式字符串，值为替换字符串，两者用空格分隔。
* 逻辑：后处理时，会遍历词表中的每一个键（正则表达式），在译文中查找匹配项并进行替换。

推荐加载的后处理词表

+ `warhammer40k`目录下的 `legion.txt`
+ `warhammer40k`目录下的 `mechanicum.txt`
+ `warhammer40k`目录下的 `names.txt`

## 5. 自定义 Prompt (可选)

* 在侧边栏“词表和 Prompt”部分的文本框中，可以输入自定义的系统提示（Prompt）。
* 这个Prompt会和每一段原文一起发送给翻译API，用于指导模型的翻译风格和行为。
* 工具已内置一个针对战锤40K翻译的默认Prompt。

## 6. 执行翻译

* 完成上述配置和文件上传后，点击侧边栏底部的“翻译”按钮。
* 工具会逐段处理原文：
  1. 应用预处理词表（如果已上传）。
  2. 将处理后的原文段落连同自定义Prompt发送给配置的API进行翻译。
  3. API返回译文后，应用后处理词表（如果已上传）。
  4. 最终的译文会显示在主内容区对应原文的右侧。
* 翻译过程中，操作日志会实时显示在侧边栏底部的“日志”区域。
* API调用具有3次重试机制，每次重试的延迟会增加。

## 7. 导出译文

* 翻译完成后，点击侧边栏底部的“导出译文”按钮。
* 工具会将所有翻译好的段落（`translatedSegments`）以下列方式组合：每段译文后跟两个换行符 (`\r\n\r\n`)。
* 生成的文件名为 `[原始文件名].translate.md`，并会自动触发浏览器下载。
  * 例如，如果上传的文件是 `chapter1.txt`，导出的文件将是 `chapter1.translate.md`。

## 8. 日志查看

* 所有重要操作，如文件上传、词表加载、翻译进度、错误信息等，都会记录在侧边栏的“日志”区域，方便追踪和排查问题。
